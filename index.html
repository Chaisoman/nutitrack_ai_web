<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriTrack AI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçé</text></svg>" />
    <!-- Use Tailwind CDN as fallback; uncomment next line if tailwind.css is generated -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- <link href="./tailwind.css" rel="stylesheet"> -->
    <script>
        // Define showSnackbar globally to avoid undefined errors
        window.showSnackbar = (message) => {
            console.log("Showing snackbar:", message);
            const snackbar = document.getElementById('snackbar');
            if (snackbar) {
                snackbar.textContent = message;
                snackbar.className = "snackbar show";
                setTimeout(() => { snackbar.className = "snackbar"; }, 3000);
            } else {
                console.error("Snackbar element not found");
            }
        };
    </script>
    <script src="./libs/react.production.min.js" onerror="console.error('Failed to load React'); window.showSnackbar('Failed to load React')"></script>
    <script src="./libs/react-dom.production.min.js" onerror="console.error('Failed to load ReactDOM'); window.showSnackbar('Failed to load ReactDOM')"></script>
    <script src="./libs/babel.min.js" onerror="console.error('Failed to load Babel'); window.showSnackbar('Failed to load Babel')"></script>
    <script src="./libs/firebase-app.js" onerror="console.error('Failed to load Firebase App'); window.showSnackbar('Failed to load Firebase App')"></script>
    <script src="./libs/firebase-database.js" onerror="console.error('Failed to load Firebase Database'); window.showSnackbar('Failed to load Firebase Database')"></script>
    <script src="./libs/Recharts.min.js" onerror="console.error('Failed to load Recharts'); window.showSnackbar('Failed to load Recharts')"></script>
    <script src="./config.js" onerror="console.error('Failed to load config.js'); window.showSnackbar('Failed to load Firebase config')"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .snackbar { 
            visibility: hidden; 
            background-color: #333; 
            color: white; 
            text-align: center; 
            border-radius: 4px; 
            padding: 16px; 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 1000; 
        }
        .snackbar.show { visibility: visible; }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="snackbar" class="snackbar"></div>
    <script type="text/babel">
        // Debug: Log rendering start
        console.log("Starting NutriTrack AI rendering...");

        // Check for required libraries
        if (!window.React) {
            console.error("React not loaded");
            window.showSnackbar("Failed to load React");
            return;
        }
        if (!window.ReactDOM) {
            console.error("ReactDOM not loaded");
            window.showSnackbar("Failed to load ReactDOM");
            return;
        }
        if (!window.Recharts) {
            console.error("Recharts not loaded");
            window.showSnackbar("Failed to load Recharts");
            return;
        }
        if (!window.Firebase) {
            console.error("Firebase not loaded");
            window.showSnackbar("Failed to load Firebase");
            return;
        }
        if (!window.firebaseConfig) {
            console.error("Firebase config not loaded");
            window.showSnackbar("Failed to load Firebase config");
            return;
        }

        // Initialize Firebase
        let db;
        try {
            const app = Firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized:", app.name);
            db = Firebase.database();
        } catch (error) {
            console.error("Firebase initialization error:", error.message);
            window.showSnackbar("Failed to connect to database: " + error.message);
            return;
        }

        // Screening Screen Component
        const ScreeningScreen = () => {
            console.log("Rendering ScreeningScreen...");
            const [muac, setMuac] = React.useState('');
            const [age, setAge] = React.useState('');
            const [image, setImage] = React.useState(null);
            const [loading, setLoading] = React.useState(false);

            const handleImageUpload = (e) => {
                console.log("Handling image upload...");
                const file = e.target.files[0];
                if (!file) {
                    window.showSnackbar("No file selected");
                    return;
                }
                if (!file.type.match('image/jpeg|image/png')) {
                    window.showSnackbar("Please select a JPEG or PNG image");
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    window.showSnackbar("Image size exceeds 5MB");
                    return;
                }
                setLoading(true);
                const reader = new FileReader();
                reader.onload = () => {
                    console.log("Image loaded successfully");
                    setImage(reader.result);
                    setLoading(false);
                };
                reader.onerror = () => {
                    window.showSnackbar("Error reading image");
                    setLoading(false);
                    console.error("FileReader error");
                };
                reader.readAsDataURL(file);
            };

            const saveData = () => {
                console.log("Saving data:", { muac, age, image });
                if (!muac || !age || !image) {
                    window.showSnackbar("Please fill all fields and upload an image");
                    return;
                }
                if (!db) {
                    window.showSnackbar("Database not initialized");
                    return;
                }
                setLoading(true);
                const patientData = {
                    muac: parseFloat(muac),
                    age: parseInt(age),
                    image: image,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };
                db.ref('patients').push(patientData)
                    .then(() => {
                        window.showSnackbar("Data saved successfully");
                        setMuac('');
                        setAge('');
                        setImage(null);
                        setLoading(false);
                        console.log("Data saved to Firebase");
                    })
                    .catch(err => {
                        window.showSnackbar("Error saving data: " + err.message);
                        setLoading(false);
                        console.error("Firebase save error:", err);
                    });
            };

            return (
                <div className="p-4 max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-4">Screening</h2>
                    {loading && <div className="loader mb-4"></div>}
                    {image && <img src={image} alt="Uploaded" className="mb-4 w-full rounded" />}
                    <input
                        type="file"
                        accept="image/jpeg,image/png"
                        onChange={handleImageUpload}
                        className="border p-2 mb-4 w-full rounded"
                    />
                    <input
                        type="number"
                        placeholder="MUAC (cm)"
                        value={muac}
                        onChange={(e) => setMuac(e.target.value)}
                        className="border p-2 mb-4 w-full rounded"
                        step="0.1"
                    />
                    <input
                        type="number"
                        placeholder="Age (years)"
                        value={age}
                        onChange={(e) => setAge(e.target.value)}
                        className="border p-2 mb-4 w-full rounded"
                    />
                    <button 
                        onClick={saveData} 
                        className="bg-green-500 text-white px-4 py-2 rounded w-full disabled:bg-gray-400"
                        disabled={loading}
                    >
                        Save Data
                    </button>
                </div>
            );
        };

        // Trends Screen Component
        const TrendsScreen = () => {
            console.log("Rendering TrendsScreen...");
            const [patients, setPatients] = React.useState([]);
            const [filter, setFilter] = React.useState('all');
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!db) {
                    window.showSnackbar("Database not initialized");
                    setLoading(false);
                    return;
                }
                const ref = db.ref('patients').limitToLast(50);
                ref.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const patientList = Object.entries(data).map(([id, patient]) => ({ id, ...patient }));
                        setPatients(filter === 'all' ? patientList : patientList.filter(p => p.status === 'pending'));
                        console.log("Patients data loaded:", patientList);
                    } else {
                        setPatients([]);
                        console.log("No patient data found");
                    }
                    setLoading(false);
                }, err => {
                    window.showSnackbar("Error fetching data: " + err.message);
                    setLoading(false);
                    console.error("Firebase fetch error:", err);
                });
                return () => ref.off();
            }, [filter]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-4">Trends</h2>
                    <select
                        onChange={(e) => setFilter(e.target.value)}
                        className="border p-2 mb-4 w-full rounded"
                    >
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                    </select>
                    {loading ? (
                        <div className="loader mb-4"></div>
                    ) : patients.length === 0 ? (
                        <p>No data available</p>
                    ) : (
                        <Recharts.LineChart
                            width={Math.min(window.innerWidth - 40, 360)}
                            height={200}
                            data={patients}
                            margin={{ top: 5, right: 10, left: 10, bottom: 5 }}
                        >
                            <Recharts.XAxis dataKey="timestamp" tick={{ fontSize: 10 }} />
                            <Recharts.YAxis tick={{ fontSize: 10 }} />
                            <Recharts.Line type="monotone" dataKey="muac" stroke="#8884d8" dot={false} />
                        </Recharts.LineChart>
                    )}
                </div>
            );
        };

        // Treatment Recommendation Screen Component
        const TreatmentRecommendationScreen = () => {
            console.log("Rendering TreatmentRecommendationScreen...");
            const [muac, setMuac] = React.useState('');
            const [age, setAge] = React.useState('');
            const [recommendation, setRecommendation] = React.useState('');

            const getRecommendation = () => {
                console.log("Generating recommendation for:", { muac, age });
                if (!muac || !age) {
                    setRecommendation("Please enter MUAC and age");
                    return;
                }
                const muacValue = parseFloat(muac);
                const ageValue = parseInt(age);
                let rec = '';
                if (ageValue < 5) {
                    if (muacValue < 11.5) {
                        rec = "Severe Acute Malnutrition (SAM): Refer to inpatient treatment with Ready-to-Use Therapeutic Food (RUTF) and medical evaluation.";
                    } else if (muacValue < 12.5) {
                        rec = "Moderate Acute Malnutrition (MAM): Provide Ready-to-Use Supplementary Food (RUSF) and outpatient follow-up.";
                    } else {
                        rec = "Normal: Continue regular monitoring and provide nutritional counseling.";
                    }
                } else {
                    if (muacValue < 18.5) {
                        rec = "Malnutrition risk: Recommend nutritional supplements and regular monitoring.";
                    } else {
                        rec = "Normal: Maintain balanced diet and routine check-ups.";
                    }
                }
                setRecommendation(rec);
            };

            return (
                <div className="p-4 max-w-md mx-auto">
                    <h2 className="text-2xl font-bold mb-4">Treatment Recommendation</h2>
                    <input
                        type="number"
                        placeholder="MUAC (cm)"
                        value={muac}
                        onChange={(e) => setMuac(e.target.value)}
                        className="border p-2 mb-4 w-full rounded"
                        step="0.1"
                    />
                    <input
                        type="number"
                        placeholder="Age (years)"
                        value={age}
                        onChange={(e) => setAge(e.target.value)}
                        className="border p-2 mb-4 w-full rounded"
                    />
                    <button onClick={getRecommendation} className="bg-blue-500 text-white px-4 py-2 rounded mb-4 w-full">Get Recommendation</button>
                    {recommendation && (
                        <div className="border p-4 rounded bg-gray-100">
                            <h3 className="font-bold">Recommendation:</h3>
                            <p>{recommendation}</p>
                        </div>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            console.log("Rendering App...");
            const [currentScreen, setCurrentScreen] = React.useState('screening');

            const renderScreen = () => {
                switch (currentScreen) {
                    case 'screening':
                        return <ScreeningScreen />;
                    case 'trends':
                        return <TrendsScreen />;
                    case 'treatment':
                        return <TreatmentRecommendationScreen />;
                    default:
                        return <ScreeningScreen />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    <nav className="bg-blue-600 text-white p-4 sticky top-0">
                        <div className="flex justify-around max-w-md mx-auto">
                            <button 
                                onClick={() => setCurrentScreen('screening')} 
                                className={`px-4 py-2 ${currentScreen === 'screening' ? 'bg-blue-800' : ''}`}
                            >
                                Screening
                            </button>
                            <button 
                                onClick={() => setCurrentScreen('trends')} 
                                className={`px-4 py-2 ${currentScreen === 'trends' ? 'bg-blue-800' : ''}`}
                            >
                                Trends
                            </button>
                            <button 
                                onClick={() => setCurrentScreen('treatment')} 
                                className={`px-4 py-2 ${currentScreen === 'treatment' ? 'bg-blue-800' : ''}`}
                            >
                                Treatment
                            </button>
                        </div>
                    </nav>
                    {renderScreen()}
                </div>
            );
        };

        // Render the app
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
            console.log("App rendered successfully");
        } catch (error) {
            console.error("Rendering error:", error.message);
            window.showSnackbar("Failed to render app: " + error.message);
        }
    </script>
</body>
</html>
